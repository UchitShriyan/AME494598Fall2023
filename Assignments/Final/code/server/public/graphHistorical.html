<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src='asyncReq.js'></script>
<script>
var chart;
var lastAddedTS = 0;
// Function to calculate average
function calculateAverage(data) {
    let sumTemp = 0, sumHumidity = 0, count = 0;
    data.forEach(item => {
        sumTemp += item.t;
        sumHumidity += item.h;
        count++;
    });
    return {
        avgTemp: sumTemp / count,
        avgHumidity: sumHumidity / count
    };
}

function getDataFromServer() {
    var selectedTime = document.getElementById('datetimeSelect').value;
    var duration = parseInt(document.getElementById('duration').value);
    var endTime = new Date(selectedTime);
    endTime.setMinutes(endTime.getMinutes() + duration);

    var url = "./getLatest"; // Modify this URL as needed to fetch data
    var callback = function(data) {
        try {
            var obj = JSON.parse(data);
            var filteredData = obj.filter(d => {
                var timestamp = new Date(getTSInFormat(parseInt(d.time)));
                return timestamp >= new Date(selectedTime) && timestamp <= endTime;
            });

            if (filteredData.length === 0) {
                console.log("No data to display for the selected time range.");
                return;
            }

            var averages = calculateAverage(filteredData);

            document.getElementById('avgTemp').innerText = 'Average Temp: ' + averages.avgTemp.toFixed(2) + 'Â°C';
            document.getElementById('avgHumidity').innerText = 'Average Humidity: ' + averages.avgHumidity.toFixed(2) + '%';

            var columns = [["x"], ["Temperature"], ["Humidity"]];
            filteredData.forEach(item => {
                columns[0].push(getTSInFormat(parseInt(item.time)));
                columns[1].push(item.t || 0);
                columns[2].push(item.h || 0);
            });

            chart.load({
                columns: columns
            });
        } catch (e) {
            console.error("Error processing data:", e);
        }
    };
    loadFile(url, callback);
}
function getTSInFormat(t)
{
	var x = new Date(t);
	return x.getFullYear() + "-" + (x.getMonth()+1) + "-" + x.getDate() + "T" + x.getHours() + ":" + x.getMinutes() + ":" + x.getSeconds();
}
function start(){
    // Initialize the date picker with the current time
    flatpickr("#datetimeSelect", { 
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: new Date() // Sets the picker to the current date and time
    });

    // Set a default duration, e.g., last hour (60 minutes)
    document.getElementById('duration').value = '60';

    // Load data based on the default values
    getDataFromServer();

    // Refresh data every 2000 milliseconds (2 seconds)
    setInterval(getDataFromServer, 2000);
}
	loadFile(url, callback);


	setInterval("getDataFromServer()", 1000);
}

</script>
</head>

<body style='text-align:center; font-family:Helvetica' onload='start()'>
	<h1> Weather Historical Data </h1>

	<input id='datetimeSelect' type='text'>
	<select id='duration'>
		<option value='10'> last 10 mins </option>
		<option value='30'> last 30 mins </option>
		<option value='60'> last hour </option>
	</select>
	<div id='data'></div>
    <p id='avgTemp'></p>
    <p id='avgHumidity'></p>

</body>
</html>
