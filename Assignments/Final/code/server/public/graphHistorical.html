<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src='asyncReq.js'></script>
    <script>
    var chart;
    var lastAddedTS = 0;
    var allData = []; // Store all data points

    function getDataFromServer() {
        var url = "./getLatest";
        var callback = function(data){
            var obj = JSON.parse(data);
            for(var i = 0; i < obj.length; i++){
                var timestamp = parseInt(obj[i].time);
                if(timestamp > lastAddedTS){
                    allData.push({timestamp: timestamp, temperature: obj[i].t || 0, humidity: obj[i].h || 0});
                    lastAddedTS = timestamp;
                }
            }
            updateDisplayedData();
        }
        loadFile(url, callback);
    }

    function getTSInFormat(t) {
        var x = new Date(t);
        return x.getFullYear() + "-" + (x.getMonth()+1) + "-" + x.getDate() + "T" + x.getHours() + ":" + x.getMinutes() + ":" + x.getSeconds();
    }

    function start() {
        flatpickr("#datetimeSelect", { 
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            onChange: updateDisplayedData // Update chart when date is changed
        });

        var url = "./getLatest";
        var callback = function(data){
            var obj = JSON.parse(data);
            var columns = [["x"],["Temperature"],["Humidity"]];
            for(var i = 0; i < obj.length; i++){
                var timestamp = parseInt(obj[i].time);
                allData.push({timestamp: timestamp, temperature: obj[i].t || 0, humidity: obj[i].h || 0});
                lastAddedTS = timestamp;
            }
            chart = c3.generate({
                bindto: '#data',
                data: {
                    x: 'x',
                    xFormat: '%Y-%m-%dT%H:%M:%S',
                    columns: columns
                },
                axis: {
                    x: {
                        type: 'timeseries',
                        tick: {
                            format: '%H:%M:%S,%Y-%m-%d',
                        }
                    }
                }
            });
        }
        loadFile(url, callback);

        setInterval(getDataFromServer, 1000);
    }

    function updateDisplayedData() {
        var selectedDate = document.getElementById('datetimeSelect').value;
        var duration = parseInt(document.getElementById('duration').value, 10) * 60 * 1000; // Convert duration to milliseconds
        var endTime = new Date(selectedDate).getTime() + duration;
        var filteredData = allData.filter(d => d.timestamp >= new Date(selectedDate).getTime() && d.timestamp <= endTime);

        var tempSum = 0, humSum = 0;
        var columns = [["x"], ["Temperature"], ["Humidity"]];
        filteredData.forEach(function(d) {
            columns[0].push(getTSInFormat(d.timestamp));
            columns[1].push(d.temperature);
            columns[2].push(d.humidity);
            tempSum += d.temperature;
            humSum += d.humidity;
        });

        var avgTemp = filteredData.length > 0 ? tempSum / filteredData.length : 0;
        var avgHum = filteredData.length > 0 ? humSum / filteredData.length : 0;

        // Display averages (optional, add elements in HTML to show this)
        console.log('Average Temperature:', avgTemp.toFixed(2), 'Â°C');
        console.log('Average Humidity:', avgHum.toFixed(2), '%');

        chart.load({
            columns: columns
        });
    }

    </script>
</head>

<body style='text-align:center; font-family:Helvetica' onload='start()'>
    <h1> Weather Historical Data </h1>

    <input id='datetimeSelect' type='text'>
    <select id='duration'>
        <option value='10'> last 10 mins </option>
        <option value='30'>last 30 mins </option>
		<option value='60'> last hour </option>
		</select>
		<div id='data'></div>
		<!-- Optional: Display average temperature and humidity -->
		<div id='averageTemp'></div>
		<div id='averageHum'></div>
</body>
</html>


