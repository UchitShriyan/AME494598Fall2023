<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src='asyncReq.js'></script>
    <script>
    var chart;
    var allData = []; // Store all data points

    function getDataFromServer() {
        var url = "./getLatest";
        var callback = function(data){
            var obj = JSON.parse(data);
            for(var i = 0; i < obj.length; i++){
                var timestamp = parseInt(obj[i].time);
                allData.push({timestamp: timestamp, temperature: obj[i].t, humidity: obj[i].h});
            }
            updateChart();
        }
        loadFile(url, callback);
    }

    function getTSInFormat(t) {
        var x = new Date(t);
        return x.getFullYear() + "-" + (x.getMonth()+1) + "-" + x.getDate() + "T" + x.getHours() + ":" + x.getMinutes() + ":" + x.getSeconds();
    }

    function start() {
        flatpickr("#datetimeSelect", { 
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            onChange: updateChart // Update chart when date is changed
        });

        chart = c3.generate({
            bindto: '#data',
            data: {
                x: 'x',
                xFormat: '%Y-%m-%dT%H:%M:%S',
                columns: [["x"], ["Temperature"], ["Humidity"]]
            },
            axis: {
                x: {
                    type: 'timeseries',
                    tick: {
                        format: '%H:%M:%S,%Y-%m-%d',
                    }
                }
            }
        });

        setInterval(getDataFromServer, 1000);
    }

    function updateChart() {
        var selectedDate = document.getElementById('datetimeSelect').value;
        var filteredData = allData.filter(d => getTSInFormat(d.timestamp) >= selectedDate);

        var tempSum = 0, humSum = 0;
        var columns = [["x"], ["Temperature"], ["Humidity"]];
        filteredData.forEach(function(d) {
            columns[0].push(getTSInFormat(d.timestamp));
            columns[1].push(d.temperature);
            columns[2].push(d.humidity);
            tempSum += d.temperature;
            humSum += d.humidity;
        });

        var avgTemp = tempSum / filteredData.length;
        var avgHum = humSum / filteredData.length;

        // Display averages
        document.getElementById('averageTemp').textContent = 'Average Temperature: ' + avgTemp.toFixed(2) + ' Â°C';
        document.getElementById('averageHum').textContent = 'Average Humidity: ' + avgHum.toFixed(2) + ' %';

        chart.load({
            columns: columns
        });
    }

    </script>
</head>

<body style='text-align:center; font-family:Helvetica' onload='start()'>
    <h1> Weather Historical Data </h1>

    <input id='datetimeSelect' type='text'>
    <div id='data'></div>
    <div id='averageTemp'></div>
    <div id='averageHum'></div>

</body>
</html>
