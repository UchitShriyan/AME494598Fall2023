<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.8/c3.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src='asyncReq.js'></script>
    <script>
        var chart;
        var lastAddedTS = 0;
        var selectedDuration = 60; // Default duration is 1 hour

        function getDataFromServer() {
            var startDate = document.getElementById('datetimeSelect').value;
            var endDate = new Date(startDate);
            endDate.setMinutes(endDate.getMinutes() + selectedDuration);
            var startDateStr = endDate.toISOString().replace('Z', ''); // Convert to ISO format without timezone

            var url = "./getLatest?startDate=" + startDateStr;
            var callback = function (data) {
                var obj = JSON.parse(data);
                var columns = [["x"], ["Temperature"], ["Humidity"]]
                for (var i = 0; i < obj.length; i++) {
                    var timestamp = parseInt(obj[i].time);
                    if (timestamp >= startDate && timestamp <= endDate) {
                        columns[0].push(getTSInFormat(timestamp));
                        columns[1].push(obj[i].t || 0);
                        columns[2].push(obj[i].h || 0);
                        lastAddedTS = timestamp;
                    }
                }

                chart.load({
                    columns: columns
                });

                // Calculate and display average temperature and humidity
                var avgTemp = 0, avgHumidity = 0;
                var count = columns[0].length - 1; // Exclude the "x" label
                for (var i = 1; i < columns[1].length; i++) {
                    avgTemp += columns[1][i];
                    avgHumidity += columns[2][i];
                }
                avgTemp /= count;
                avgHumidity /= count;

                document.getElementById('avgTemp').textContent = 'Average Temperature: ' + avgTemp.toFixed(2) + 'Â°C';
                document.getElementById('avgHumidity').textContent = 'Average Humidity: ' + avgHumidity.toFixed(2) + '%';
            }
            loadFile(url, callback);
        }

        function getTSInFormat(t) {
            var x = new Date(t);
            return x.getFullYear() + "-" + (x.getMonth() + 1) + "-" + x.getDate() + "T" + x.getHours() + ":" + x.getMinutes() + ":" + x.getSeconds();
        }

        function start() {
            flatpickr("#datetimeSelect", {
                enableTime: true,
                dateFormat: "Y-m-d H:i"
            });

            document.getElementById('duration').addEventListener('change', function () {
                selectedDuration = parseInt(this.value);
                getDataFromServer();
            });

            var url = "./getLatest";
            var callback = function (data) {
                var obj = JSON.parse(data);
                var columns = [["x"], ["Temperature"], ["Humidity"]]
                for (var i = 0; i < obj.length; i++) {
                    var timestamp = parseInt(obj[i].time);
                    columns[0].push(getTSInFormat(timestamp));
                    columns[1].push(obj[i].t || 0);
                    columns[2].push(obj[i].h || 0);
                    lastAddedTS = timestamp;
                }
                chart = c3.generate({
                    bindto: '#data',
                    data: {
                        x: 'x',
                        xFormat: '%Y-%m-%dT%H:%M:%S',
                        columns: columns
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            tick: {
                                format: '%H:%M:%S,%Y-%m-%d',
                            }
                        }
                    }
                });

                getDataFromServer();
                setInterval("getDataFromServer()", 1000);
            }

            loadFile(url, callback);
        }

    </script>
</head>

<body style='text-align:center; font-family:Helvetica' onload='start()'>
<h1> Weather Historical Data </h1>

<input id='datetimeSelect' type='text'>
<select id='duration'>
    <option value='10'> last 10 mins </option>
    <option value='30'> last 30 mins </option>
    <option value='60'> last hour </option>
</select>
<div id='data'></div>

<p id='avgTemp'></p>
<p id='avgHumidity'></p>

</body>
</html>
